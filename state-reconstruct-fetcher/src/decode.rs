use std::vec::Vec;
use std::option::Option;

pub enum Chunk {
    Number(u32),
    Buffer(Vec<u8>),
}

pub struct DecodeResult {
    opcode: u8,
    number: u32,
    size: u8,
}

pub fn decode_flatten(buffer: Vec<u8>) -> Option<Vec<u8>> {
    let chunks = decompile(buffer)?;
    let mut result: Vec<u8> = Vec::new();
    for chunk in chunks {
        match chunk {
            Chunk::Number(n) => {
                return None;
            },
            Chunk::Buffer(b) => {
                result.extend(b);
            },
        }
    }
    Some(result)
}

pub fn decompile(buffer: Vec<u8>) -> Option<Vec<Chunk>> {
    let mut chunks: Vec<Chunk> = Vec::new();
    let mut i = 0;

    while i < buffer.len() {
        let opcode = buffer[i];

        if opcode > OPS::OP_0 && opcode <= OPS::OP_PUSHDATA4 {
            let d = decode(&buffer, i);

            match d {
                None => return None,
                Some(d) => {
                    i += d.size as usize;

                    if i + d.number as usize > buffer.len() {
                        return None;
                    }

                    let data = buffer[i..i + d.number as usize].to_vec();
                    i += d.number as usize;

                    match as_minimal_op(&data) {
                        None => chunks.push(Chunk::Buffer(data)),
                        Some(op) => chunks.push(Chunk::Number(op as u32)),
                    }
                }
            }
        } else {
            chunks.push(Chunk::Number(opcode as u32));
            i += 1;
        }
    }

    Some(chunks)
}

pub fn as_minimal_op(buffer: &Vec<u8>) -> Option<u8> {
    if buffer.len() == 0 {
        return Some(OPS::OP_0);
    }
    if buffer.len() != 1 {
        return None;
    }
    if buffer[0] >= 1 && buffer[0] <= 16 {
        return Some(OPS::OP_RESERVED + buffer[0]);
    }
    if buffer[0] == 0x81 {
        return Some(OPS::OP_1NEGATE);
    }
    None
}

pub fn decode(buffer: &Vec<u8>, offset: usize) -> Option<DecodeResult> {
    let opcode = buffer[offset];
    let num: u32;
    let size: u8;

    if opcode < OPS::OP_PUSHDATA1 {
        num = opcode as u32;
        size = 1;
    } else if opcode == OPS::OP_PUSHDATA1 {
        if offset + 2 > buffer.len() {
            return None;
        }
        num = buffer[offset + 1] as u32;
        size = 2;
    } else if opcode == OPS::OP_PUSHDATA2 {
        if offset + 3 > buffer.len() {
            return None;
        }
        num = (buffer[offset + 1] as u32) | ((buffer[offset + 2] as u32) << 8);
        
        size = 3;
    } else {
        if offset + 5 > buffer.len() {
            return None;
        }
        if opcode != OPS::OP_PUSHDATA4 {
            return None;
        }
        num = (buffer[offset + 1] as u32) | ((buffer[offset + 2] as u32) << 8) | ((buffer[offset + 3] as u32) << 16) | ((buffer[offset + 4] as u32) << 24);

        size = 5;
    }

    Some(DecodeResult {
        opcode,
        number: num,
        size,
    })
}

pub struct OPS;
impl OPS {
    pub const OP_0: u8 = 0;
    pub const OP_PUSHDATA1: u8 = 76;
    pub const OP_PUSHDATA2: u8 = 77;
    pub const OP_PUSHDATA4: u8 = 78;
    pub const OP_1NEGATE: u8 = 79;
    pub const OP_RESERVED: u8 = 80;
}

#[cfg(test)]
mod tests {
    use super::*;
    use hex;

    #[test]
    fn test_decompile() {
        let hex_string = "4d0802082096e53fcbe0ce90a858712926cb4f496779a25ddaf3ac3c7ce3b3a03209a80328193b480b55d0ef841a66fa17c3f4e449ee58fb13fb6b512cad66112c49518f7b701f58c50000000000000000000000000000000000000000000000000000000000000139fd0222d110a7d9bf3f5cbee1af56a9da70a95af2ea2c7dba72f4c07c287533f4000000000000000000000000000000000000000000000000000000000000224b0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666acef93c517672c139a24498808cc3cdc3aa24f61fa65eb5cb8deb0678501e3cafd2ad000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000013a00000000000000000000000000000000000000000000000000000000666b53c0000000000000000000000000000000000000000000000000000000000000224d9d2a4d0802fa083bf0952c444d155ba98c71787a3e91c1a45fc2a227fc94de5cd7d9d30000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470672aaca00f3300737e0f9aed26d7e30c7d89e1406e36968c6cd5e753bd423038f25e3232d7c941e685a005d803fe3e596c6dd2fa19e0cc7a3360750970b958fb00000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000480000000000000000000000000000000000000000000000000000000000000031800000000000000000000000000000000000000000000800b0000000000000000000000000000000000000000000000000000000000000004fd0222d110a7d9bf3f5cbee1af56a9da70a95af2ea2c7dba72f4c07c287533f400000001000000000000000000000000000000000000800b0000000000000000000000000000000000000000000000000000000000000003000000000000000000000000666b53c0000000000000000000000000666b53c10001000100000000000000000000000000000000000080010000000000000000000000000000000000000000000000000000000000000005c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a47000014d08020001000000000000000000000000000000000000800100000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000100010000000000000000000000000000000000008011000000000000000000000000000000000000000000000000000000000000000753d869a18c1b4fd80d4a9c73b4c077146a3607c58208011845cab8b302a9f4cc000100010000000000000000000000000000000000008011000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000001000100000000000000000000000000000000000080080000000000000000000000000000000000000000000000000000000000000000a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00010001000000000000000000000000000000000000800800000000000000000000000000000000000000000000000000000000000000012828ed05cc9dd60d92465d089d9014de76b42516df1b37adc0c30345ddd9d11b00010001000000000000000000000000000000000000800800000000000000000000000000000000000000000000000000000000000000021524bbd49be982242a3f91f75272329e7da4951545360def882a4d08026a4ee9d248c500000000000000000000000000000000000000000000000000000000000000000000000000000041003a6fda53bf201c386b47c6f159d7911803c46f1491497e29429e95a834947dc03733b21081ead97270f803a49bb96810748d02a9915f30b4dd46040fe8cd7535000000000000000000000000000000000000000000000000000000000000007f61885c0000000000000000000000000000000000000000000000000000000000000139fd0222d110a7d9bf3f5cbee1af56a9da70a95af2ea2c7dba72f4c07c287533f4000000000000000000000000000000000000000000000000000000000000224b0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666acef93c517672c139a24498808cc3cdc3aa24f61fa65eb5cb8deb0678501e3cafd2ad000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000004d08020000000000000000013a9d2afa083bf0952c444d155ba98c71787a3e91c1a45fc2a227fc94de5cd7d9d3000000000000000000000000000000000000000000000000000000000000224d0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666b53c012a5529b72966a98ff0816f8baff1c15cfd6227d8060dfce2818c25366d06274000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c1ac3e95df61a187d4db37b37109efe0dc2506d5ddf735bf6fa5036423948bde627c1c9bacfa7e277bd5151ac4948566c0147f7f530b05cf966c02592ea42627d2b7f3a8f19d7f3572965d8a6fa1f7e41a436cc7c0c468893a411922bba912e2c033f41a93d9d746a626212e2de56403cc758292e9142a819ed15c0c3bd18e8e815aeef74693856201c2524b6d46b1bf494da96cfcc7bdd78bc85a48d0be04d08028dbd10e4d201bf116e4bfe4d928ed58ccefdacde93e4893ac8d18bd6b3ceb98e806c290d356539592db07a0050afa8649c6164e9c7ce4415fb8b78ff5893555e2a2c258cb84954257d34ccdba1eb3d3c312542da465f953856e6510d0f69eb31c7301b1a11f85b0d85d2cb4b1062cb16a67729398654686c5a5d88edd6e86024cbd820e9d02613b61501be15efa378f592626ef7cb081a04e63728b0a564348853a92558e6309443eec5fde4d0b5175b4474597803d85106eb6908bba51fcb62891d157e25f8cff3192718e053d239a358cbf80799ab4a0cb3c58476f84e3c72e9e80f6cc007f923698badaabaf81e6a3bc684073dada60d392e482745e9efc6ab77157df6a234e878c95e7e3f972a7ee20308b6dfa354d8da21ebab782035674c2f109a9c0a7a03c738ad194a61ac2c0e9c06bae0bb719e91ff76773c8363224ea81c38683eb1eb448a7e981793221f43e90ffffac91241959b3d46cca93e4c2cff1bbe19ed67e879cd65224062f55cbb636228a2f4a4fa3460c30db56dab6ad92a11d7e71da2e5d1d5b717b6fe7b1cd6aaf8fa62a2c3c8c38ae18fb3a97fa81e4a0ccd09e5d25bf885da6d7944fe92d3e9eb150884f2d43474ec37b0b0e6c923c10f085f4f53fb7c9e6d3382bcc67168bdf5b143e6b0e53aa9f5bd376122c4d0522f7fea6c0b34e6de55ded90424023788f65b3163cba94dfaef3c79d4b68f4f090a38162cd4164d08022d5ffa4e74fd5b9385b481db1f5c24a4d53a73f31ad637c342d02ea2996947e91b70bbad1cec8f7ff3526168c8c923ab1a12cf3aebf88608301c0601c153c8931ce1ec7549c5614a4272c9ae0db70c258b28048834a27bf3a5a60f34a34f092871db3a59b56f4d35bdbef5be3058c77a9aa5792590d974702e12056b02761eff142ff5e375d501e57048a9a411ee9bb26beef3bb26ed14a2e2302263950232dd4ca40bf633b0e768d53153bee098d62d84b30490d7569a96761b21fc13f5699e6dd88645b0e0beaa9d424f0038a0c4adfc469729c16e66aebaeb07529afad8f0699c9a751698a492b8c50f6193959ccba8728a5d2c9ffd9d71f72a1fce23d9ab297568998fe483162ca19a6c562a531f91ccc39f91c08f17ee9505a927f0ed576edef4de9a83a69d919e71dedc8d02dc5ea0405e412c786ed4fe073a253877e0baade674ebb46d0615979eddaa817421e5d7347c9fc7dc90b61919554711fcf6863620e9d2a71e8fe946495a06e4dc3dcbac36aebb63169d991a082365eb288750887003bc9d3bc0010e86ddcb9273db6006311f315a11e57bad0bcf3272d813768a459ee324dedfc3fe145cdccb55070a7023f0f39adc44d0fb1f50d1ced6d3db8a8147a947a1e09ec721b89de84db3dc9141c41fc57f72f8f623d387eb51208292db5f5d79a0fecebfd7a3a862e8b2faa341656652d46cb4a711ea4a4c068085f5eec253e309614d0802ea9fb64b4c1a6851b9fc3ed6c622e9abc8e52c6cd47ff5ce596874eb12c8ada3c2efaee9dac90aa7242be26817fcce391ae5055bc7c6f81a20b8f777f3665837653550dce1f0e0a33801357df6909dc0e7bc20a1d394dd04ccb5b26f1bfc23b2a72c25911f164643eb491baa86f5682f55d0041d80123f8767ad11de5ba125e56299277cef1e2b6666c4889501ab056b6d1401f874f2efb04d3803c037a376d65e045da804c1697fec14099c80d815b3b73d2317e53187c7b5a1c8116bfdcc7b0b83c1c048ffea52e7f5333214bed216425bc3d93e7c00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000013a9d2afa083bf0952c444d155ba98c71787a3e91c1a45fc2a227fc94de5cd7d9d3000000000000000000000000000000000000000000000000000000000000224d0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666b53c012a5529b72966a98ff0816f8baff1c15cfd64d0e01227d8060dfce2818c25366d06274000000000000000000000000000000000000000000000000000000000000013b8041e4baa61ce06be73a50c0e78a51f513040e55fb35524b144bc39b747f664f000000000000000000000000000000000000000000000000000000000000224f0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666b61d51d14b5e001786769f1ed23d4e51f732e49275f6b1fb4ef0ed94fd1ca22c701fc";
        let buffer = hex::decode(hex_string).expect("Decoding failed");
        let result = decompile(buffer);
        assert!(result.is_some());
        assert_eq!(result.as_ref().unwrap().len(), 9);
        // println!("result {}", result.as_ref().unwrap().len());
        let mut concatenated: Vec<u8> = vec![];
        for chunk in result.as_ref().unwrap() {
            match chunk {
                Chunk::Number(n) => {
                    // println!("Number: {}", n)
                },
                Chunk::Buffer(b) => {
                    concatenated.extend(b)
                    // println!("Buffer of length {}", b.len())
                },
            }
        }
        
        let lengths = result.as_ref().unwrap().iter().map(|c| {
            match c {
                Chunk::Number(_) => 1,
                Chunk::Buffer(b) => b.len(),
            }
        }).collect::<Vec<usize>>();
        assert_eq!(lengths, [520, 520, 520, 520, 520, 520, 520, 520, 270]);
        // println!("concat result {:?}", hex::encode(concatenated));
        let expected_result = "082096e53fcbe0ce90a858712926cb4f496779a25ddaf3ac3c7ce3b3a03209a80328193b480b55d0ef841a66fa17c3f4e449ee58fb13fb6b512cad66112c49518f7b701f58c50000000000000000000000000000000000000000000000000000000000000139fd0222d110a7d9bf3f5cbee1af56a9da70a95af2ea2c7dba72f4c07c287533f4000000000000000000000000000000000000000000000000000000000000224b0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666acef93c517672c139a24498808cc3cdc3aa24f61fa65eb5cb8deb0678501e3cafd2ad000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000013a00000000000000000000000000000000000000000000000000000000666b53c0000000000000000000000000000000000000000000000000000000000000224d9d2afa083bf0952c444d155ba98c71787a3e91c1a45fc2a227fc94de5cd7d9d30000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470672aaca00f3300737e0f9aed26d7e30c7d89e1406e36968c6cd5e753bd423038f25e3232d7c941e685a005d803fe3e596c6dd2fa19e0cc7a3360750970b958fb00000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000480000000000000000000000000000000000000000000000000000000000000031800000000000000000000000000000000000000000000800b0000000000000000000000000000000000000000000000000000000000000004fd0222d110a7d9bf3f5cbee1af56a9da70a95af2ea2c7dba72f4c07c287533f400000001000000000000000000000000000000000000800b0000000000000000000000000000000000000000000000000000000000000003000000000000000000000000666b53c0000000000000000000000000666b53c10001000100000000000000000000000000000000000080010000000000000000000000000000000000000000000000000000000000000005c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a47000010001000000000000000000000000000000000000800100000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000100010000000000000000000000000000000000008011000000000000000000000000000000000000000000000000000000000000000753d869a18c1b4fd80d4a9c73b4c077146a3607c58208011845cab8b302a9f4cc000100010000000000000000000000000000000000008011000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000001000100000000000000000000000000000000000080080000000000000000000000000000000000000000000000000000000000000000a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00010001000000000000000000000000000000000000800800000000000000000000000000000000000000000000000000000000000000012828ed05cc9dd60d92465d089d9014de76b42516df1b37adc0c30345ddd9d11b00010001000000000000000000000000000000000000800800000000000000000000000000000000000000000000000000000000000000021524bbd49be982242a3f91f75272329e7da4951545360def882a6a4ee9d248c500000000000000000000000000000000000000000000000000000000000000000000000000000041003a6fda53bf201c386b47c6f159d7911803c46f1491497e29429e95a834947dc03733b21081ead97270f803a49bb96810748d02a9915f30b4dd46040fe8cd7535000000000000000000000000000000000000000000000000000000000000007f61885c0000000000000000000000000000000000000000000000000000000000000139fd0222d110a7d9bf3f5cbee1af56a9da70a95af2ea2c7dba72f4c07c287533f4000000000000000000000000000000000000000000000000000000000000224b0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666acef93c517672c139a24498808cc3cdc3aa24f61fa65eb5cb8deb0678501e3cafd2ad000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000013a9d2afa083bf0952c444d155ba98c71787a3e91c1a45fc2a227fc94de5cd7d9d3000000000000000000000000000000000000000000000000000000000000224d0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666b53c012a5529b72966a98ff0816f8baff1c15cfd6227d8060dfce2818c25366d06274000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c1ac3e95df61a187d4db37b37109efe0dc2506d5ddf735bf6fa5036423948bde627c1c9bacfa7e277bd5151ac4948566c0147f7f530b05cf966c02592ea42627d2b7f3a8f19d7f3572965d8a6fa1f7e41a436cc7c0c468893a411922bba912e2c033f41a93d9d746a626212e2de56403cc758292e9142a819ed15c0c3bd18e8e815aeef74693856201c2524b6d46b1bf494da96cfcc7bdd78bc85a48d0be08dbd10e4d201bf116e4bfe4d928ed58ccefdacde93e4893ac8d18bd6b3ceb98e806c290d356539592db07a0050afa8649c6164e9c7ce4415fb8b78ff5893555e2a2c258cb84954257d34ccdba1eb3d3c312542da465f953856e6510d0f69eb31c7301b1a11f85b0d85d2cb4b1062cb16a67729398654686c5a5d88edd6e86024cbd820e9d02613b61501be15efa378f592626ef7cb081a04e63728b0a564348853a92558e6309443eec5fde4d0b5175b4474597803d85106eb6908bba51fcb62891d157e25f8cff3192718e053d239a358cbf80799ab4a0cb3c58476f84e3c72e9e80f6cc007f923698badaabaf81e6a3bc684073dada60d392e482745e9efc6ab77157df6a234e878c95e7e3f972a7ee20308b6dfa354d8da21ebab782035674c2f109a9c0a7a03c738ad194a61ac2c0e9c06bae0bb719e91ff76773c8363224ea81c38683eb1eb448a7e981793221f43e90ffffac91241959b3d46cca93e4c2cff1bbe19ed67e879cd65224062f55cbb636228a2f4a4fa3460c30db56dab6ad92a11d7e71da2e5d1d5b717b6fe7b1cd6aaf8fa62a2c3c8c38ae18fb3a97fa81e4a0ccd09e5d25bf885da6d7944fe92d3e9eb150884f2d43474ec37b0b0e6c923c10f085f4f53fb7c9e6d3382bcc67168bdf5b143e6b0e53aa9f5bd376122c4d0522f7fea6c0b34e6de55ded90424023788f65b3163cba94dfaef3c79d4b68f4f090a38162cd4162d5ffa4e74fd5b9385b481db1f5c24a4d53a73f31ad637c342d02ea2996947e91b70bbad1cec8f7ff3526168c8c923ab1a12cf3aebf88608301c0601c153c8931ce1ec7549c5614a4272c9ae0db70c258b28048834a27bf3a5a60f34a34f092871db3a59b56f4d35bdbef5be3058c77a9aa5792590d974702e12056b02761eff142ff5e375d501e57048a9a411ee9bb26beef3bb26ed14a2e2302263950232dd4ca40bf633b0e768d53153bee098d62d84b30490d7569a96761b21fc13f5699e6dd88645b0e0beaa9d424f0038a0c4adfc469729c16e66aebaeb07529afad8f0699c9a751698a492b8c50f6193959ccba8728a5d2c9ffd9d71f72a1fce23d9ab297568998fe483162ca19a6c562a531f91ccc39f91c08f17ee9505a927f0ed576edef4de9a83a69d919e71dedc8d02dc5ea0405e412c786ed4fe073a253877e0baade674ebb46d0615979eddaa817421e5d7347c9fc7dc90b61919554711fcf6863620e9d2a71e8fe946495a06e4dc3dcbac36aebb63169d991a082365eb288750887003bc9d3bc0010e86ddcb9273db6006311f315a11e57bad0bcf3272d813768a459ee324dedfc3fe145cdccb55070a7023f0f39adc44d0fb1f50d1ced6d3db8a8147a947a1e09ec721b89de84db3dc9141c41fc57f72f8f623d387eb51208292db5f5d79a0fecebfd7a3a862e8b2faa341656652d46cb4a711ea4a4c068085f5eec253e30961ea9fb64b4c1a6851b9fc3ed6c622e9abc8e52c6cd47ff5ce596874eb12c8ada3c2efaee9dac90aa7242be26817fcce391ae5055bc7c6f81a20b8f777f3665837653550dce1f0e0a33801357df6909dc0e7bc20a1d394dd04ccb5b26f1bfc23b2a72c25911f164643eb491baa86f5682f55d0041d80123f8767ad11de5ba125e56299277cef1e2b6666c4889501ab056b6d1401f874f2efb04d3803c037a376d65e045da804c1697fec14099c80d815b3b73d2317e53187c7b5a1c8116bfdcc7b0b83c1c048ffea52e7f5333214bed216425bc3d93e7c00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000013a9d2afa083bf0952c444d155ba98c71787a3e91c1a45fc2a227fc94de5cd7d9d3000000000000000000000000000000000000000000000000000000000000224d0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666b53c012a5529b72966a98ff0816f8baff1c15cfd6227d8060dfce2818c25366d06274000000000000000000000000000000000000000000000000000000000000013b8041e4baa61ce06be73a50c0e78a51f513040e55fb35524b144bc39b747f664f000000000000000000000000000000000000000000000000000000000000224f0000000000000000000000000000000000000000000000000000000000000000c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470a707d1c62d8be699d34cb74804fdd7b4c568b6c1a821066f126c680d4b83e00b00000000000000000000000000000000000000000000000000000000666b61d51d14b5e001786769f1ed23d4e51f732e49275f6b1fb4ef0ed94fd1ca22c701fc";
        assert_eq!(hex::encode(concatenated), expected_result);

        
    }
}
